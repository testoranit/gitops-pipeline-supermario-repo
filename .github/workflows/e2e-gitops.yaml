  update_k8s_deployment:
    runs-on: ubuntu-latest
    needs: scan_container_image
    steps:
      - name: Checkout Repository with PAT
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Configure Git
        run: |
          git config --global user.name "${{ secrets.GIT_USERNAME }}"
          git config --global user.email "${{ secrets.GIT_EMAIL }}"

      - name: Install yq (Go version by mikefarah)
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Update Deployment Image in deployment.yaml
        run: |
          VERSION=${{ needs.build_push_supermario_image.outputs.version }}
          IMAGE_TAG="${DOCKER_IMAGE}:${VERSION}"
          DEPLOY_FILE=deployment.yaml

          DEPLOYMENT=$(yq 'select(.kind == "Deployment")' $DEPLOY_FILE)
          SERVICE=$(yq 'select(.kind == "Service")' $DEPLOY_FILE)

          UPDATED_DEPLOYMENT=$(echo "$DEPLOYMENT" | yq '.spec.template.spec.containers[] |= (select(.image | test("supermariogitopsproject")) | .image = strenv(IMAGE_TAG))')

          echo "$UPDATED_DEPLOYMENT" > $DEPLOY_FILE
          echo "---" >> $DEPLOY_FILE
          echo "$SERVICE" >> $DEPLOY_FILE

      - name: Commit and Rebase Push Updated Deployment
        run: |
          git add deployment.yaml
          git commit -m "Update deployment.yaml with new image tag" || echo "No changes to commit"
          git pull --rebase origin main
          git push origin main
